<!-- æ–‡ç« å†…å®¹å¸ƒå±€é¡µ -->
<!DOCTYPE html>
<html lang="en">
  <!-- head.htmlå­˜æ”¾é¡µé¢é€šç”¨çš„å…ƒæ•°æ®ã€cssã€jsç­‰é“¾æ¥èµ„æº -->
<head>
  <meta name="generator" content="Hugo 0.79.1" />
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Java SPI | Luyik754081's blog</title>
  <meta name="description" content="Loji44&#39;s Blog. Focus on Java, Linux, Golang, Git, Vim, Docker, etc." />
  <meta name="viewport" content="width=device-width" />
  <link href="/favicon.png" rel="icon" />
  <link rel="stylesheet" href="/static/css/github.css" />
  <link rel="stylesheet" href="/static/css/style.css" />
  <link rel="stylesheet" href="/static/css/search.css" />

  <script src="//cdn.staticfile.org/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="/static/js/is.min.js"></script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <script type="text/javascript" src="/static/js/search.js" defer="true"></script>
</head>
  <body>
    <div id="container">
      <!-- å…¨å±€é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="header">
  <span class="title"><a href="/">Luyik754081's blog</a></span>
  
    
    
    &#47;&nbsp;<a class="extra" href="/about.html">About</a>
  
    
    
    &#47;&nbsp;<a class="extra" href="/tags.html">TAGS</a>
  
    
    
    &#47;&nbsp;<a class="extra" href="/search.html">ğŸ”SEARCH</a>
  
</div>
      <div class="site">
        <!-- postæ–‡ç« çš„æ ‡é¢˜éƒ¨åˆ† -->
<div id="page_header">
  <div id="page_title">
    <h1>Java SPI</h1>
  </div>
  <div id="page_meta">
    <span class="page_meta_tags">
      &#91;&nbsp;
      
        <!-- '/'å’Œç©ºæ ¼è½¬æ¢æˆ'-'ã€tagè‹±æ–‡è½¬æ¢æˆå°å†™å­—æ¯ -->
        
        <a class="extra" href="/tags/java.html">#Java</a>
      
        <!-- '/'å’Œç©ºæ ¼è½¬æ¢æˆ'-'ã€tagè‹±æ–‡è½¬æ¢æˆå°å†™å­—æ¯ -->
        
        <a class="extra" href="/tags/spi.html">#SPI</a>
      
      &nbsp;&#93;
    </span>
    <span class="page_meta_date">
        &#91;&nbsp;12 October 2019&nbsp;&#93;
    </span>
  </div>
</div>

        <div class="post">
          <h3 id="1-spiæœºåˆ¶ä»‹ç»ä¸ä½¿ç”¨">1. SPIæœºåˆ¶ä»‹ç»ä¸ä½¿ç”¨</h3>

<p>Java SPIæ˜¯Javaç”¨äºæ„å»ºå…·å¤‡å¯æ‰©å±•æ€§çš„åº”ç”¨çš„ä¸€ç§æœºåˆ¶ã€‚æ‰€è°“çš„å…·å¤‡å¯æ‰©å±•æ€§ï¼Œå°±æ˜¯å¯ä»¥é€šè¿‡æŸç§æ–¹å¼è®©ä½¿ç”¨è€…åœ¨ä¸æ›´æ”¹è¿™ä¸ªåº”ç”¨æºä»£ç çš„åŸºç¡€ä¸Šå»åœ¨è¿™ä¸ªåº”ç”¨ä¸Šæ·»åŠ æ–°çš„åŠŸèƒ½ç‰¹æ€§ã€‚</p>

<p>å…ˆçœ‹çœ‹ä¸‰ä¸ªæ¦‚å¿µï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Service</code>ï¼šå°±æ˜¯å…·å¤‡å¯æ‰©å±•æ€§çš„åº”ç”¨æœåŠ¡ï¼Œå¯æ‰©å±•çš„å¯¹å¤–æ¥å£å°±æ˜¯ç”±å®ƒå®šä¹‰ï¼›</li>
  <li><code class="language-plaintext highlighter-rouge">Service provider interface (SPI)</code>ï¼šServiceå®šä¹‰çš„ä¸€ç»„å¼€æ”¾çš„æ¥å£ï¼Œç§°ä¸ºSPIæ¥å£ï¼›</li>
  <li><code class="language-plaintext highlighter-rouge">Service Provider</code>ï¼šæœåŠ¡æä¾›è€…ï¼Œè´Ÿè´£å®ç°SPIæ¥å£ï¼Œæä¾›å…·ä½“çš„å®ç°ã€‚ä¾‹å¦‚ç”Ÿäº§å•†ã€‚</li>
</ul>

<p>Serviceå®šä¹‰SPIæ¥å£å¹¶ä»¥<code class="language-plaintext highlighter-rouge">jar</code>åŒ…çš„æ–¹å¼å¯¹å¤–å‘å¸ƒã€‚è‹¥ç¬¬ä¸‰æ–¹ï¼ˆService Providerï¼‰æƒ³åœ¨Serviceåº”ç”¨ä¸Šå®ç°è‡ªå·±æƒ³è¦çš„ç‰¹æ€§ï¼Œé‚£Service Providerå°±å¯ä»¥å¼•å…¥è¿™ä¸ª<code class="language-plaintext highlighter-rouge">SPI jar</code>åŒ…ï¼Œå¹¶æä¾›è‡ªå·±çš„å®ç°ã€‚</p>

<p><img src="/static/image/2019/java-spi-workflow.png" alt="spi" /></p>

<p>ä¸Šå›¾å°±æ˜¯SPIæœºåˆ¶çš„è¿ä½œæµç¨‹ã€‚æ¥ä¸‹æ¥ä»‹ç»Serviceå¦‚ä½•å‘ç°å¹¶åŠ è½½Service Provideræä¾›çš„SPIæ¥å£çš„å®ç°ã€‚</p>

<p>å‡è®¾æœ‰ä¸€ä¸ªServiceï¼šæ‰“å°æœºæœåŠ¡åº”ç”¨ï¼Œå¯¹ç”¨æˆ·æä¾›æ‰“å°æœåŠ¡ã€‚è¿™ä¸ªæ‰“å°æœºæœåŠ¡åº”ç”¨å¾ˆå¼ºå¤§ï¼Œå¯ä»¥åšåˆ°é€‚é…ä»»ä½•å‚å®¶çš„æ‰“å°è®¾å¤‡ï¼Œå› ä¸ºè¿™ä¸ªæ‰“å°æœåŠ¡åº”ç”¨åœ¨è®¾è®¡çš„æ—¶å€™è€ƒè™‘åˆ°äº†å¯æ‰©å±•æ€§ã€‚</p>

<p>è¿™ä¸ªæ‰“å°æœåŠ¡åº”ç”¨å®šä¹‰çš„ä¸€ä¸ªæ ‡å‡†SPIæ¥å£ï¼š<code class="language-plaintext highlighter-rouge">com.loji44.spi.Printer</code>ï¼Œè¿™ä¸ªæ¥å£ä¼šä»¥jaråŒ…çš„æ–¹å¼å¯¹å¤–å‘å¸ƒã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.loji44.spi</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Printer</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">print</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç„¶åæœ‰ä¸€ä¸ªæ‰“å°æœºè®¾å¤‡å‚å•†ä½³èƒ½å¼•å…¥è¿™ä¸ªjaråŒ…ä¾èµ–ï¼Œå¹¶æä¾›è‡ªå·±çš„å®ç°ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.canon.printer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.loji44.spi.Printer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CanonPrinter</span> <span class="kd">implements</span> <span class="nc">Printer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">print</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä½³èƒ½æ‰“å°æœºä¸ºæ‚¨æœåŠ¡ï¼š"</span> <span class="o">+</span> <span class="n">text</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"ä½³èƒ½æ‰“å°æœºä¸ºæ‚¨æœåŠ¡ï¼š"</span> <span class="o">+</span> <span class="n">text</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åšå¥½å®ç°åï¼Œæ ¹æ®SPIæœºåˆ¶çš„è§„èŒƒï¼Œä½³èƒ½å‚å•†éœ€è¦åœ¨è‡ªå·±æºä»£ç çš„<code class="language-plaintext highlighter-rouge">src/main/resources/META-INF/services</code>ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªåä¸ºSPIæ¥å£å…¨é™å®šåçš„æ–‡æœ¬æ–‡ä»¶ï¼Œé‡Œé¢çš„å†…å®¹ä¸ºè‡ªå·±å®ç°ç±»çš„å…¨é™å®šåï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="/static/image/2019/spi-canon-provider.png" alt="spi-canon-provider" /></p>

<p>æ¥ä¸‹æ¥ï¼Œæ‰“å°æœåŠ¡åº”ç”¨ï¼ˆServiceï¼‰å¼•å…¥ä½³èƒ½å‚å•†æä¾›çš„å®ç°jaråŒ…ï¼ˆä¾‹å¦‚é€šè¿‡Mavenå¼•å…¥ï¼‰ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.canon<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>canon-printer<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>å¼•å…¥äº†ä½³èƒ½å‚å•†æä¾›çš„å®ç°jaråŒ…ä¾èµ–ä¹‹åï¼Œå°±å¯ä»¥åŠ è½½å¹¶ä½¿ç”¨ä½³èƒ½æ‰“å°è®¾å¤‡æä¾›çš„æ‰“å°æœåŠ¡äº†ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.ServiceLoader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.loji44.spi.Printer</span><span class="o">;</span>

<span class="c1">// æˆ‘æ˜¯æ‰“å°æœºæœåŠ¡åº”ç”¨ï¼Œè¿™é‡Œæ˜¯å¯åŠ¨æ‰“å°æœåŠ¡çš„å…¥å£</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrinterLauncher</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="nc">Printer</span><span class="o">&gt;</span> <span class="n">serviceLoader</span> <span class="o">=</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Printer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">serviceLoader</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">printer</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">printer</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"æˆ‘è¦æ‰“å°å¾ˆå¤šé’±"</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// è¿è¡Œç»“æœ</span>
<span class="n">ä½³èƒ½æ‰“å°æœºä¸ºæ‚¨æœåŠ¡</span><span class="err">ï¼š</span><span class="n">æˆ‘è¦æ‰“å°å¾ˆå¤šé’±</span>
</code></pre></div></div>

<p>æˆ‘ä»¬åœ¨æ²¡æœ‰ä¿®æ”¹æ‰“å°æœºæœåŠ¡åº”ç”¨ï¼ˆPrinterLauncherï¼‰çš„æºä»£ç çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡SPIæ‰©å±•æœºåˆ¶æˆåŠŸä½¿ç”¨äº†ä½³èƒ½çš„æ‰“å°è®¾å¤‡ï¼</p>

<p>åŒæ ·çš„ï¼Œå¦‚æœæœ‰å¦ä¸€å®¶æ‰“å°æœºè®¾å¤‡å‚å•†ï¼ˆä¾‹å¦‚æƒ æ™®ï¼‰ä»¥åŒæ ·çš„åšæ³•æä¾›äº†è‡ªå·±çš„å®ç°ï¼Œé‚£ä¹ˆæ‰“å°æœºæœåŠ¡åº”ç”¨ï¼ˆPrinterLauncherï¼‰åŒæ ·åªéœ€è¦å¼•å…¥æƒ æ™®å‚å•†æä¾›çš„å®ç°jaråŒ…ä¾èµ–ï¼Œå°±å¯ä»¥ä½¿ç”¨å…¶æä¾›çš„æ‰“å°æœåŠ¡ã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¯´çš„åŠŸèƒ½æ‰©å±•äº†ã€‚</p>

<h3 id="2-spiå‘ç°ä¸åŠ è½½çš„å¥¥ç§˜">2. SPIå‘ç°ä¸åŠ è½½çš„å¥¥ç§˜</h3>

<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹å‡ è¡Œä»£ç å°±å¯ä»¥å‘ç°ã€åŠ è½½å¹¶ä½¿ç”¨æœåŠ¡æä¾›å•†æä¾›çš„SPIå®ç°ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="nc">Printer</span><span class="o">&gt;</span> <span class="n">serviceLoader</span> <span class="o">=</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Printer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">serviceLoader</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">printer</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">printer</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"æˆ‘è¦æ‰“å°å¾ˆå¤šé’±"</span><span class="o">);</span>
<span class="o">});</span>
</code></pre></div></div>

<p>æ²¡é”™ï¼ŒJava SPIæœåŠ¡æä¾›å•†æä¾›çš„å®ç°æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">java.util.ServiceLoader</code>è¿™ä¸ªç±»æ¥å®ŒæˆæŸ¥æ‰¾ã€åŠ è½½å¹¶ä½¿ç”¨çš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•æŸ¥æ‰¾å¹¶åŠ è½½SPIå®ç°ç±»çš„ï¼š</p>

<ul>
  <li>ServiceLoader.load(Printer.class)</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">load</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">service</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
    <span class="k">return</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">cl</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><em>ClassLoader cl = Thread.currentThread().getContextClassLoader()</em> è¿™è¡Œä»£ç æ˜¯è·å–å½“å‰çº¿ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œç”¨æ¥åŠ è½½å‚å•†æä¾›çš„å®ç°ç±»ï¼ˆç±»åŠ è½½è‚¯å®šæ˜¯ç”±ç±»åŠ è½½å™¨æ¥å®Œæˆï¼‰ã€‚</p>

<p>è¿™é‡Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å…¶ä»–ç±»åŠ è½½å™¨ï¼Œä¾‹å¦‚å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap Classloaderï¼‰æˆ–è€…æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension Classloaderï¼‰</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç¡®ï¼š</p>

<ul>
  <li>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap Classloaderï¼‰åªä¼šåŠ è½½<code class="language-plaintext highlighter-rouge">JAVA_HOME/lib</code>ç›®å½•ä¸‹çš„JavaåŸºç¡€ç±»åº“ï¼Œè€Œä¸”åªä¼šåŠ è½½åå­—ç¬¦åˆçš„ç±»åº“ï¼Œä¾‹å¦‚<code class="language-plaintext highlighter-rouge">rt.jar</code>ã€‚å¯¹äºåŠ è½½èŒƒå›´å’Œç±»åº“åç§°æœ‰ç€ä¸¥æ ¼çš„è¦æ±‚ï¼Œæ‰€ä»¥å°±ç®—ä½ æŠŠè‡ªå·±çš„jaråŒ…æ”¾å…¥<code class="language-plaintext highlighter-rouge">JAVA_HOME/lib</code>ä¸‹é¢ï¼Œä¹Ÿä¸ä¼šè¢«å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ï¼›</li>
  <li>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension Classloaderï¼‰ä¹Ÿä¸€æ ·ï¼Œå®ƒåªä¼šåŠ è½½<code class="language-plaintext highlighter-rouge">JAVA_HOME/lib/ext</code>ç›®å½•ä¸‹çš„ç±»åº“ï¼›</li>
  <li>åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆApplication Classloaderï¼‰ç”¨æ¥åŠ è½½ç”¨æˆ·Classpathä¸‹é¢çš„ç±»åº“ï¼Œå³åŠ è½½æˆ‘ä»¬å¼€å‘ä¸­å¼•å…¥çš„å„ç§ç¬¬ä¸‰æ–¹ç±»åº“ã€‚</li>
</ul>

<p>æˆ‘ä»¬çŸ¥é“ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ˜¯è·Ÿçº¿ç¨‹ç»‘å®šçš„ï¼Œåˆ›å»ºçº¿ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè¯¥çº¿ç¨‹è®¾ç½®ä¸€ä¸ªç±»åŠ è½½å™¨ï¼ˆå³çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼‰ã€‚å¦‚æœä¸è®¾ç½®ï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨ç»§æ‰¿çˆ¶çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œè€ŒJavaåº”ç”¨è¿è¡Œçš„åˆå§‹çº¿ç¨‹ç»‘å®šçš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å°±æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆApplication Classloaderï¼‰ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">java.util.ServiceLoader</code>æ˜¯<code class="language-plaintext highlighter-rouge">rt.jar</code>ç±»åº“é‡Œé¢çš„ä¸€ä¸ªç±»ï¼Œè‚¯å®šæ˜¯ç”±Bootstrap ClassloaderåŠ è½½çš„ã€‚å‚å•†çš„ç±»å…¶å®æ˜¯æ”¾åœ¨ç”¨æˆ·Classpathä¸‹é¢çš„ï¼Œè®©ServiceLoaderå»åŠ è½½å‚å•†çš„ç±»ï¼Œå¦‚æœä¸ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œé‚£ä¹ˆJVMä¼šé»˜è®¤ä½¿ç”¨åŠ è½½<code class="language-plaintext highlighter-rouge">java.util.ServiceLoader</code>ç±»çš„ç±»åŠ è½½å™¨ï¼Œå³Bootstrap Classloaderå»åŠ è½½å‚å•†çš„ç±»ã€‚Bootstrap Classloaderæ˜¯ä¸å¯èƒ½è®¤è¯†å‚å•†ç±»çš„ï¼Œå› ä¸ºå®ƒåªè®¤è¯†<code class="language-plaintext highlighter-rouge">JAVA_HOME/lib</code>ç›®å½•ä¸‹çš„ç±»åº“ï¼Œé‚£æˆ‘è¦åŠ è½½å‚å•†çš„ç±»æ€ä¹ˆåŠï¼Ÿ</p>

<p>ç­”æ¡ˆå°±æ˜¯Bootstrap Classloaderå§”æ‰˜åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆApplication Classloaderï¼‰å»åŠ è½½å‚å•†çš„ç±»ï¼Œå› ä¸ºApplication Classloaderå°±æ˜¯ä¸“é—¨ç”¨æ¥åŠ è½½ç”¨æˆ·Classpathçš„ç±»åº“çš„ã€‚è¿™é‡Œå…¶å®ç ´åäº†JVMç±»åŠ è½½çš„ã€ŒåŒäº²å§”æ´¾ã€æ¨¡å‹ï¼Œå³çˆ¶ç±»åŠ è½½å™¨å§”æ‰˜å­ç±»åŠ è½½å™¨å»åŠ è½½ä¸€ä¸ªç±»ã€‚</p>

<blockquote>
  <p>JVMç±»åŠ è½½çš„ã€ŒåŒäº²å§”æ´¾ã€åŠ è½½æ¨¡å‹è§„å®šï¼šå½“JVMæ”¶åˆ°ä¸€ä¸ªç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒä¸ä¼šç›´æ¥åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯å§”æ‰˜å®ƒçš„çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½ï¼Œæ¯ä¸€å±‚éƒ½æ˜¯è¿™æ ·ï¼Œé€å±‚å¾€ä¸Šä¼ é€’è¯·æ±‚ï¼Œç›´åˆ°é¡¶å±‚ç±»åŠ è½½å™¨Bootstrap Classloaderã€‚å¦‚æœçˆ¶ç±»åŠ è½½å™¨åŠ è½½ä¸åˆ°ï¼Œå­ç±»åŠ è½½å™¨æ‰ä¼šè‡ªå·±æ‰§è¡ŒåŠ è½½åŠ¨ä½œã€‚</p>
</blockquote>

<p>è¯´äº†è¿™ä¹ˆå¤šï¼Œæ€»ç»“èµ·æ¥å°±ä¸€ç‚¹ï¼šBootstrap Classloaderä¸è®¤è¯†ç”¨æˆ·Classpathä¸‹çš„ç±»ï¼Œé‚£ä¹ˆå®ƒå°±é€šè¿‡çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ¥åšä¸€äº›ã€Œå˜é€šã€ï¼Œå› ä¸ºçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨åœ¨æ²¡æœ‰äººä¸ºè®¾ç½®è¿‡çš„æ—¶å€™é»˜è®¤å°±æ˜¯Application Classloaderï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥åŠ è½½åˆ°å‚å•†çš„ç±»äº†ã€‚</p>

<blockquote>
  <p>å¯èƒ½æœ‰äººåˆè¦é—®ï¼šé‚£ä¸ºä»€ä¹ˆ<code class="language-plaintext highlighter-rouge">java.util.ServiceLoader</code>ä¸ç›´æ¥æŒ‡å®šApplication Classloaderå»åŠ è½½å‚å•†çš„ç±»ï¼Œè€Œéè¦é€šè¿‡çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å»è½¬ä¸€é“ï¼Ÿ<br />
ä»£ç ç›´æ¥å†™æ­»æŒ‡å®šä½¿ç”¨Application Classloaderä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯ä¸§å¤±äº†çµæ´»æ€§ã€‚ä½œä¸ºåŸºç¡€é€šç”¨çš„æ¡†æ¶ï¼Œä½ è¦ç•™ç»™ç”¨æˆ·ä¸€ä¸ªé€‰æ‹©çš„ä½™åœ°ï¼Œå› ä¸ºé€šè¿‡çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œç”¨æˆ·æ˜¯å¯ä»¥è®¾ç½®è¿™ä¸ªçº¿ç¨‹ä½¿ç”¨å…¶ä»–ç±»åŠ è½½å™¨çš„ï¼Œä¾‹å¦‚ç”¨æˆ·çš„ç¨‹åºé‡Œé¢è‡ªå®šä¹‰äº†å…¶ä»–ç±»åŠ è½½å™¨ã€‚</p>
</blockquote>

<p>å¥½äº†ï¼Œå…³äºåŠ è½½å‚å•†ç±»çš„ç±»åŠ è½½å™¨ç›¸å…³å†…å®¹å°±è¯´åˆ°è¿™é‡Œã€‚ç»§ç»­æˆ‘ä»¬çš„ <em>ServiceLoader.load</em>ï¼Œå…¶å®æœ€ç»ˆå°±æ˜¯<code class="language-plaintext highlighter-rouge">new</code>ä¸€ä¸ªServiceLoaderçš„å®ä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="nf">load</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">service</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">loader</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">ServiceLoader</span><span class="o">&lt;&gt;(</span><span class="n">service</span><span class="o">,</span> <span class="n">loader</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ¥çœ‹çœ‹ServiceLoaderçš„ç§æœ‰æ„é€ å™¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// å°†è¦è¢«åŠ è½½çš„SPIæ¥å£ç±»çš„Classå¯¹è±¡ï¼Œä¾‹å¦‚ Printer.class</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">service</span><span class="o">;</span>
    <span class="c1">// ç”¨äºåŠ è½½SPIæœåŠ¡æä¾›å•†æä¾›çš„å®ç°ç±»çš„ç±»åŠ è½½å™¨</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ClassLoader</span> <span class="n">loader</span><span class="o">;</span>
    <span class="c1">// SPIæœåŠ¡æä¾›å•†æä¾›çš„å®ç°ç±»çš„å®ä¾‹çš„ç¼“å­˜ï¼šåŠ è½½åˆ°å¹¶å®ä¾‹åŒ–åï¼Œç¼“å­˜èµ·æ¥</span>
    <span class="kd">private</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">providers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="c1">// ServiceLoaderè‡ªå·±å®ç°çš„ä¸€ä¸ªæ‡’åŠ è½½çš„è¿­ä»£å™¨ï¼šè¿™ä¸ªæ˜¯é‡ç‚¹</span>
    <span class="kd">private</span> <span class="nc">LazyIterator</span> <span class="n">lookupIterator</span><span class="o">;</span>
        
    <span class="c1">// ç§æœ‰æ„é€ å™¨    </span>
    <span class="kd">private</span> <span class="nf">ServiceLoader</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">svc</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">cl</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">service</span> <span class="o">=</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">svc</span><span class="o">,</span> <span class="s">"Service interface cannot be null"</span><span class="o">);</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="o">(</span><span class="n">cl</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="nc">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">()</span> <span class="o">:</span> <span class="n">cl</span><span class="o">;</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getSecurityManager</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="nc">AccessController</span><span class="o">.</span><span class="na">getContext</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">reload</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ServiceLoaderç§æœ‰æ„é€ å™¨é‡Œé¢å‰é¢ä¸‰è¡Œä»£ç ä¸»è¦åšä¸€äº›åˆå§‹åŒ–æ£€æŸ¥å·¥ä½œï¼Œé‡ç‚¹åœ¨äºreload()æ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">reload</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">providers</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">lookupIterator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LazyIterator</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">loader</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>å…ˆæ¸…ç†ä¹‹å‰åŠ è½½è¿‡çš„å®ç°ç±»ï¼Œå³æ¯æ¬¡è°ƒç”¨ServiceLoader.loadçš„æ—¶å€™ï¼Œéƒ½ä¼šä¿è¯æ¸…ç†ä¹‹å‰åŠ è½½çš„å®ç°ç±»ç¼“å­˜ï¼›</li>
  <li>åˆå§‹åŒ–ä¸€ä¸ªæ‡’åŠ è½½çš„è¿­ä»£å™¨ã€‚</li>
</ul>

<p>åˆ°è¿™é‡ŒServiceLoader.loadå…¶å®å°±èµ°å®Œäº†ï¼Œå¯ä»¥çœ‹åˆ°ServiceLoader.loadå…¶å®ä¸æ˜¯çœŸæ­£å»æŸ¥æ‰¾ã€åŠ è½½å‚å•†çš„å®ç°ç±»ï¼Œè€Œæ˜¯åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼Œå…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªLazyIteratorã€‚</p>

<p>é‚£å‚å•†çš„å®ç°ç±»åœ¨ä»€ä¹ˆæ—¶å€™è¿›è¡ŒæŸ¥æ‰¾ã€åŠ è½½å‘¢ï¼Ÿ</p>

<p>ç­”æ¡ˆæ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™æ‰è¿›è¡Œå®ç°ç±»çš„åŠ è½½ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="nc">Printer</span><span class="o">&gt;</span> <span class="n">serviceLoader</span> <span class="o">=</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Printer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">serviceLoader</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">printer</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">printer</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"æˆ‘è¦æ‰“å°å¾ˆå¤šé’±"</span><span class="o">);</span>
<span class="o">});</span>
</code></pre></div></div>

<p>åˆšæ‰è¯´äº†ï¼Œè°ƒç”¨ServiceLoader.loadçš„æ—¶å€™ä¼šåˆå§‹åŒ–ä¸€ä¸ªLazyIteratorï¼Œå½“æˆ‘ä»¬ä½¿ç”¨serviceLoader.forEachå»éå†å‚å•†å®ç°ç±»çš„æ—¶å€™ï¼Œå…¶å®å°±æ˜¯æŸ¥æ‰¾å¹¶åŠ è½½å‚å•†çš„å®ç°ç±»ã€‚</p>

<p>LazyIteratoræ˜¯ServiceLoaderçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œå®ƒå®ç°äº†<code class="language-plaintext highlighter-rouge">Iterator</code>æ¥å£ï¼Œç”¨äºè¿­ä»£åŠ è½½å®ç°ç±»ã€‚å…ˆæ¥çœ‹LazyIteratorçš„nextServiceæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="no">S</span> <span class="nf">nextService</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">hasNextService</span><span class="o">())</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
    
    <span class="nc">String</span> <span class="n">cn</span> <span class="o">=</span> <span class="n">nextName</span><span class="o">;</span>
    <span class="n">nextName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">cn</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">loader</span><span class="o">);</span>
    <span class="c1">// æ­¤å¤„çœç•¥ä¸é‡è¦çš„ä»£ç  ...</span>
    <span class="no">S</span> <span class="n">p</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">newInstance</span><span class="o">());</span>
    <span class="n">providers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">cn</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
    <span class="c1">// æ­¤å¤„çœç•¥ä¸é‡è¦çš„ä»£ç  ...</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>nextServiceæ–¹æ³•åšäº†å››ä»¶äº‹æƒ…ï¼š</p>

<ul>
  <li>è°ƒç”¨hasNextServiceæ–¹æ³•æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯è¿˜æœ‰å¯è¿­ä»£çš„å®ç°ç±»ã€‚è¿™é‡Œæ³¨æ„ï¼Œå¦‚æœæ˜¯é¦–æ¬¡è°ƒç”¨hasNextServiceæ–¹æ³•ï¼ŒhasNextServiceä¼šå»æŸ¥æ‰¾<code class="language-plaintext highlighter-rouge">META-INF/services</code>ä¸‹é¢ä»¥SPIæ¥å£å…¨é™å®šåå‘½åçš„æ–‡æœ¬æ–‡ä»¶å¹¶é€è¡Œè¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ”¾å…¥ä¸€ä¸ªå«pendingçš„ç¼“å­˜å˜é‡ã€‚åé¢æ¯æ¬¡è¿­ä»£è°ƒç”¨hasNextServiceæ—¶ï¼Œéƒ½ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ä¸‹ä¸€è¡Œçš„å†…å®¹æ”¾å…¥nextNameå˜é‡è¿”å›ï¼›</li>
  <li>nextNameå°±æ˜¯å®ç°ç±»çš„å…¨é™å®šåï¼ŒnextServiceæ–¹æ³•ä¸­è°ƒç”¨Class.forNameæ¥åŠ è½½æ­¤å®ç°ç±»ï¼Œä¼ å…¥çš„loaderå°±æ˜¯æˆ‘ä»¬ä¹‹å‰è¯´çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆé»˜è®¤ä¸ºApplication Classloaderï¼‰ï¼›</li>
  <li>å¦‚æœæˆåŠŸåŠ è½½ï¼Œåˆ™é€šè¿‡åå°„åˆ›å»ºè¯¥å®ç°ç±»çš„å®ä¾‹ï¼›</li>
  <li>å°†è¯¥å®ç°ç±»çš„å®ä¾‹ç¼“å­˜åˆ°providersè¿™ä¸ªMapå˜é‡ä¸­ï¼Œåç»­å†è¿­ä»£ï¼Œå°±ä¼šç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œä¸ä¼šå†åˆ›å»ºå®ä¾‹äº†ã€‚</li>
</ul>

<p>hasNextServiceæ–¹æ³•å…¶å®å°±æ˜¯ä¼šåœ¨é¦–æ¬¡è°ƒç”¨çš„æ—¶å€™å»è¯»å–ä»¥SPIæ¥å£å…¨é™å®šåå‘½åçš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œå†…å®¹ï¼Œå› ä¸ºæ¯ä¸€è¡Œå°±ä»£è¡¨ä¸€ä¸ªå®ç°ç±»ï¼ˆå‚å•†å¯ä»¥æä¾›å¤šä¸ªå®ç°ç±»ï¼‰ï¼Œå¹¶å°†æ¯ä¸€ä¸ªå®ç°ç±»çš„å…¨é™å®šåä¿å­˜åˆ°ä¸€ä¸ªpendingå˜é‡ä¸­ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">class</span> <span class="nc">LazyIterator</span> <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nc">Class</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="n">service</span><span class="o">;</span>
    <span class="nc">ClassLoader</span> <span class="n">loader</span><span class="o">;</span>
    <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">URL</span><span class="o">&gt;</span> <span class="n">configs</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">pending</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">nextName</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">hasNextService</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">configs</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// è¿™é‡Œçš„PREFIXå°±æ˜¯ "META-INF/services/"</span>
                <span class="c1">// fullNameåœ¨è¿™é‡Œå°±æ˜¯ "META-INF/services/com.loji44.spi.Printer"</span>
                <span class="nc">String</span> <span class="n">fullName</span> <span class="o">=</span> <span class="no">PREFIX</span> <span class="o">+</span> <span class="n">service</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">loader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">configs</span> <span class="o">=</span> <span class="nc">ClassLoader</span><span class="o">.</span><span class="na">getSystemResources</span><span class="o">(</span><span class="n">fullName</span><span class="o">);</span>
                <span class="k">else</span>
                    <span class="c1">// è¯»å–æ–‡ä»¶èµ„æº</span>
                    <span class="c1">// è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦æ±‚æä¾›å®ç°çš„å‚å•†åœ¨ "src/main/resources/META-INF/services" ä¸‹åˆ›å»ºä»¥SPIæ¥å£å…¨é™å®šåä¸ºæ–‡ä»¶åçš„æ–‡æœ¬æ–‡ä»¶</span>
                    <span class="n">configs</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">fullName</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">fail</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="s">"Error locating configuration files"</span><span class="o">,</span> <span class="n">x</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">pending</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pending</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">configs</span><span class="o">.</span><span class="na">hasMoreElements</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// é€è¡Œè§£æ com.loji44.spi.Printer æ–‡ä»¶å†…å®¹</span>
            <span class="n">pending</span> <span class="o">=</span> <span class="n">parse</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">configs</span><span class="o">.</span><span class="na">nextElement</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="c1">// æ–‡ä»¶ä¸­æ¯ä¸€è¡Œå†…å®¹å°±æ˜¯ä¸€ä¸ªå®ç°ç±»çš„å…¨é™å®šå</span>
        <span class="n">nextName</span> <span class="o">=</span> <span class="n">pending</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ServiceLoader.load</code>åªæ˜¯åˆå§‹åŒ–äº†åŠ è½½å®ç°ç±»æ‰€éœ€è¦çš„ä¸€äº›å‚æ•°ï¼›</li>
  <li>å½“ä½¿ç”¨<code class="language-plaintext highlighter-rouge">serviceLoader.forEach</code>å»è¿­ä»£å®ç°ç±»çš„å®ä¾‹çš„æ—¶å€™ï¼Œæ‰ä¼šçœŸæ­£è§¦å‘å‚å•†å®ç°ç±»çš„æŸ¥æ‰¾ã€åŠ è½½ã€‚</li>
</ul>

<h3 id="3-spiæœºåˆ¶çš„åº”ç”¨">3. SPIæœºåˆ¶çš„åº”ç”¨</h3>

<p>Java SPIåœ¨å®é™…ä¸­æœ‰å¾ˆå¤šåº”ç”¨ï¼Œä¾‹å¦‚æˆ‘ä»¬æåˆ°çš„æ‰“å°æœºçš„ä¾‹å­ã€‚</p>

<p>è¿˜æœ‰ä¸€äº›æ›´å¸¸ç”¨çš„ä¾‹å¦‚JDKçš„æ•°æ®åº“é©±åŠ¨ç®¡ç†ã€‚JDKé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªæ ‡å‡†çš„æ•°æ®åº“é©±åŠ¨çš„æ¥å£<code class="language-plaintext highlighter-rouge">java.sql.Driver</code>è®©å„ä¸ªæ•°æ®åº“å‚å•†ï¼ˆä¾‹å¦‚MySQLã€PostgreSQLï¼‰å»æä¾›è‡ªå·±çš„å®ç°ã€‚å„ä¸ªæ•°æ®åº“å‚å•†åªéœ€è¦éµå¾ª<code class="language-plaintext highlighter-rouge">java.sql.Driver</code>æ¥å£çš„è§„èŒƒæ¥å¼€å‘è‡ªå·±çš„é©±åŠ¨ï¼Œç„¶åç”¨æˆ·åœ¨ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦å¼•å…¥å„ä¸ªæ•°æ®åº“å‚å•†çš„jaråŒ…ä¾èµ–å³å¯ä½¿ç”¨å¯¹åº”çš„æ•°æ®åº“ã€‚</p>

<p>æœ€åï¼ŒJDKè¿˜æä¾›äº†ä¸€ä¸ªç±»æ¥åŠ è½½ã€ç®¡ç†å„ä¸ªå‚å•†çš„æ•°æ®åº“é©±åŠ¨ï¼š<code class="language-plaintext highlighter-rouge">java.sql.DriverManager</code>ï¼Œè€ŒDriverManageré‡Œé¢æ­£æ˜¯ä½¿ç”¨SPIçš„ServiceLoaderæ¥å®Œæˆé©±åŠ¨çš„åŠ è½½çš„ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">java.sql.DriverManager</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DriverManager</span> <span class="o">{</span>
    <span class="c1">// ... ...</span>
    
    <span class="kd">static</span> <span class="o">{</span>
        <span class="c1">// DriverManageråœ¨ç±»åŠ è½½é˜¶æ®µå°±ä¼šå»åŠ è½½å¹¶åˆå§‹åŒ–æ•°æ®åº“é©±åŠ¨</span>
        <span class="n">loadInitialDrivers</span><span class="o">();</span>
        <span class="n">println</span><span class="o">(</span><span class="s">"JDBC DriverManager initialized"</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// ... ... </span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">loadInitialDrivers</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// ... ...</span>
        
        <span class="c1">// å¦‚æœDriveræ˜¯ä»¥SPIçš„Service Provideræ–¹å¼æä¾›ï¼Œå°±ä½¿ç”¨ServiceLoaderæ¥åŠ è½½Driver</span>
        <span class="nc">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="k">new</span> <span class="nc">PrivilegedAction</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="nc">Void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="nc">Driver</span><span class="o">&gt;</span> <span class="n">loadedDrivers</span> <span class="o">=</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Driver</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Driver</span><span class="o">&gt;</span> <span class="n">driversIterator</span> <span class="o">=</span> <span class="n">loadedDrivers</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="c1">// æ‰§è¡Œè¿­ä»£ï¼šçœŸæ­£è§¦å‘é©±åŠ¨ç±»çš„æŸ¥æ‰¾å’ŒåŠ è½½ã€å®ä¾‹åŒ–</span>
                    <span class="k">while</span><span class="o">(</span><span class="n">driversIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">driversIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Do nothing</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>

       <span class="c1">// ... ...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å†çœ‹çœ‹MySQLæä¾›çš„å®ç°ç±»çš„jaråŒ…é‡Œé¢ï¼šæ²¡é”™ï¼Œå°±æ˜¯æ ‡å‡†çš„SPIæ–¹å¼æä¾›çš„å®ç°äº†ã€‚</p>

<p><img src="/static/image/2019/mysql-driver.png" alt="mysql-driver" /></p>

<h3 id="4-å†™åœ¨æœ€å">4. å†™åœ¨æœ€å</h3>

<ul>
  <li>ServiceLoaderå®ä¾‹æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿­ä»£æŸ¥æ‰¾ã€åŠ è½½å®ç°ç±»çš„æ—¶å€™ï¼Œé‡Œé¢å¹¶æ²¡æœ‰ä»»ä½•åŒæ­¥æªæ–½ï¼›</li>
  <li>SPIè™½è¯´ä½¿ç”¨çš„æ˜¯æ‡’åŠ è½½è¿­ä»£å™¨ï¼Œä½†æ˜¯åœ¨æ‰§è¡Œè¿­ä»£çš„æ—¶å€™ï¼Œä¸ç®¡ç”¨æ²¡ç”¨åˆ°å¯¹åº”çš„å®ç°ï¼ŒSPIéƒ½ä¼šå…¨éƒ¨åŠ è½½ã€åˆ›å»ºå®ä¾‹ï¼Œè€Œä¸èƒ½æ ¹æ®æˆ‘ä»¬æ‰€éœ€æŒ‡å®šåŠ è½½æŸä¸ªå®ç°ç±»ã€‚</li>
</ul>

<hr />


        </div>
      </div>
    </div>
  </body>
  <div class="footer">
  <p>Copyright Â© 2021-2023&nbsp;|&nbsp;Powered by <a href="http://jekyllcn.com" target="_blank">Jekyll</a>. Theme by <a href="https://github.com/loji44/ExSimple" target="_blank">ExSimple</a>.</p>
</div>
</html>
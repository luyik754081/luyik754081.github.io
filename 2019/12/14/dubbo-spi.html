<!-- æ–‡ç« å†…å®¹å¸ƒå±€é¡µ -->
<!DOCTYPE html>
<html lang="en">
  <!-- head.htmlå­˜æ”¾é¡µé¢é€šç”¨çš„å…ƒæ•°æ®ã€cssã€jsç­‰é“¾æ¥èµ„æº -->
<head>
  <meta name="generator" content="Hugo 0.79.1" />
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Dubbo SPI | Luyik754081's blog</title>
  <meta name="description" content="Loji44&#39;s Blog. Focus on Java, Linux, Golang, Git, Vim, Docker, etc." />
  <meta name="viewport" content="width=device-width" />
  <link href="/favicon.png" rel="icon" />
  <link rel="stylesheet" href="/static/css/github.css" />
  <link rel="stylesheet" href="/static/css/style.css" />
  <link rel="stylesheet" href="/static/css/search.css" />

  <script src="//cdn.staticfile.org/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="/static/js/is.min.js"></script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <script type="text/javascript" src="/static/js/search.js" defer="true"></script>
</head>
  <body>
    <div id="container">
      <!-- å…¨å±€é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="header">
  <span class="title"><a href="/">Luyik754081's blog</a></span>
  
    
    
    &#47;&nbsp;<a class="extra" href="/about.html">About</a>
  
    
    
    &#47;&nbsp;<a class="extra" href="/tags.html">TAGS</a>
  
    
    
    &#47;&nbsp;<a class="extra" href="/search.html">ğŸ”SEARCH</a>
  
</div>
      <div class="site">
        <!-- postæ–‡ç« çš„æ ‡é¢˜éƒ¨åˆ† -->
<div id="page_header">
  <div id="page_title">
    <h1>Dubbo SPI</h1>
  </div>
  <div id="page_meta">
    <span class="page_meta_tags">
      &#91;&nbsp;
      
        <!-- '/'å’Œç©ºæ ¼è½¬æ¢æˆ'-'ã€tagè‹±æ–‡è½¬æ¢æˆå°å†™å­—æ¯ -->
        
        <a class="extra" href="/tags/dubbo.html">#Dubbo</a>
      
        <!-- '/'å’Œç©ºæ ¼è½¬æ¢æˆ'-'ã€tagè‹±æ–‡è½¬æ¢æˆå°å†™å­—æ¯ -->
        
        <a class="extra" href="/tags/spi.html">#SPI</a>
      
      &nbsp;&#93;
    </span>
    <span class="page_meta_date">
        &#91;&nbsp;14 December 2019&nbsp;&#93;
    </span>
  </div>
</div>

        <div class="post">
          <p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡Java SPIæœºåˆ¶ï¼š<a href="/2019/10/12/java-spi.html" target="_blank">Java SPI</a>ã€‚<a href="https://dubbo.apache.org/zh/" target="_blank">Dubbo</a> å…¶å®ä¹Ÿæœ‰è‡ªå·±çš„ä¸€å¥—SPIæœºåˆ¶ï¼Œä½†è·ŸJava SPIæœ‰æ‰€åŒºåˆ«ã€‚è¿™ç¯‡æ–‡ç« æ˜¯åœ¨å­¦ä¹ äº†Dubbo SPIçš„åŸç†ä¹‹åå†™çš„ï¼Œå¾ˆå¤šä¸œè¥¿ç›´æ¥å€Ÿé‰´åŸæ–‡ï¼Œä½†æ˜¯ç›®çš„ä¸ºäº†å·©å›ºæ‰€å­¦ï¼ŒåŠ æ·±ç†è§£ã€‚</p>

<h3 id="ä¸€dubbo-spiçš„ä½¿ç”¨">ä¸€ã€Dubbo SPIçš„ä½¿ç”¨</h3>

<p>ä¸Java SPIç›¸ä¼¼ï¼ŒDubboä¹Ÿæ˜¯é€šè¿‡ç‰¹å®šçš„ç›®å½•å»åŠ è½½SPIæ‰©å±•ç±»ï¼Œåªä¸è¿‡ä¸¤è€…åŠ è½½æ‰©å±•ç±»çš„ç›®å½•ä¸åŒï¼šJavaçš„SPIæœºåˆ¶ä»<code class="language-plaintext highlighter-rouge">META-INF/services</code>ç›®å½•åŠ è½½ï¼ŒDubbo SPIä»<code class="language-plaintext highlighter-rouge">META-INF/dubbo</code>ç›®å½•åŠ è½½ã€‚</p>

<p>ä½¿ç”¨Dubbo SPIæ—¶ï¼Œå¯¹å¤–å‘å¸ƒçš„SPIæ¥å£å¿…é¡»éƒ½åŠ ä¸Š<code class="language-plaintext highlighter-rouge">@SPI</code>çš„æ³¨è§£ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.loji44.spi</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.dubbo.common.extension.SPI</span><span class="o">;</span>

<span class="nd">@SPI</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PrinterV2</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">print</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>å®ç°æ–¹æä¾›å¥½å®ç°ä¹‹åï¼Œåœ¨è‡ªå·±æºä»£ç çš„<code class="language-plaintext highlighter-rouge">META-INF/dubbo</code>ç›®å½•ä¸‹é¢æ–°å¢ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åå°±æ˜¯SPIæ¥å£çš„å…¨é™å®šåï¼š</p>

<p><img src="/static/image/2020/dubbo-spi.png" alt="dubbo-spi.png" /></p>

<p>æ¥ä¸‹æ¥çœ‹çœ‹æ€ä¹ˆåŠ è½½å¹¶ä½¿ç”¨æ‰©å±•ç±»ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PrinterLauncher</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Dubbo SPIæœºåˆ¶ä½¿ç”¨</span>
        <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="nc">PrinterV2</span><span class="o">&gt;</span> <span class="n">extensionLoader</span> <span class="o">=</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="nc">PrinterV2</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        
        <span class="c1">// åŠ è½½ epson-v1 æ‰©å±•ç±»</span>
        <span class="nc">PrinterV2</span> <span class="n">printerV2</span> <span class="o">=</span> <span class="n">extensionLoader</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="s">"epson-v1"</span><span class="o">);</span>
        <span class="n">printerV2</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"æˆ‘è¦æ‰“å°å¾ˆå¤šé’±"</span><span class="o">);</span>
        
        <span class="c1">// åŠ è½½ epson-v2 æ‰©å±•ç±»</span>
        <span class="n">printerV2</span> <span class="o">=</span> <span class="n">extensionLoader</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="s">"epson-v2"</span><span class="o">);</span>
        <span class="n">printerV2</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"æˆ‘è¦æ‰“å°å¾ˆå¤šé’±"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="c1">// è¿è¡Œç»“æœ</span>
<span class="n">çˆ±æ™®ç”Ÿç¬¬ä¸€ä»£æ‰“å°æœºä¸ºæ‚¨æœåŠ¡</span><span class="err">ï¼š</span><span class="n">æˆ‘è¦æ‰“å°å¾ˆå¤šé’±</span>
<span class="n">çˆ±æ™®ç”Ÿç¬¬äºŒä»£æ‰“å°æœºä»¥</span><span class="err">ã€Œ</span><span class="mi">10</span><span class="n">å€</span><span class="err">ã€</span><span class="n">é€Ÿåº¦ä¸ºæ‚¨æœåŠ¡</span><span class="err">ï¼š</span><span class="n">æˆ‘è¦æ‰“å°å¾ˆå¤šé’±</span>
</code></pre></div></div>

<h3 id="äºŒdubbo-spiæºç ">äºŒã€Dubbo SPIæºç </h3>

<blockquote>
  <p>æºç åŸºäº Apache Dubbo 2.7.5 ç‰ˆæœ¬ã€‚</p>
</blockquote>

<p>Dubbo SPIå°è£…åœ¨<code class="language-plaintext highlighter-rouge">org.apache.dubbo.common.extension.ExtensionLoader</code>ç±»ä¸­ã€‚</p>

<p>ç¬¬ä¸€æ­¥ï¼šå…ˆçœ‹çœ‹<code class="language-plaintext highlighter-rouge">getExtensionLoader</code>æ–¹æ³•ï¼šåŸºäºSPIæ¥å£Classç±»å‹è·å–ExtensionLoaderçš„å®ä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getExtensionLoader</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Extension type == null"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">type</span><span class="o">.</span><span class="na">isInterface</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Extension type ("</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span> <span class="s">") is not an interface!"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">withExtensionAnnotation</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// SPIæ¥å£å¿…é¡»åŠ ä¸ŠDubboæä¾›çš„@SPIæ³¨è§£</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Extension type ("</span> <span class="o">+</span> <span class="n">type</span> <span class="o">+</span>
                    <span class="s">") is not an extension, because it is NOT annotated with @"</span> <span class="o">+</span> <span class="no">SPI</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">loader</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;)</span> <span class="no">EXTENSION_LOADERS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">loader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// è¿™é‡Œç›´æ¥é’ˆå¯¹æŸä¸ªSPIæ¥å£çš„Classç±»å‹åšä¸€ä¸ªæœ¬åœ°ç¼“å­˜ï¼Œä¸‹æ¬¡å†æ¥å°±ä»ç¼“å­˜å–</span>
            <span class="no">EXTENSION_LOADERS</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;(</span><span class="n">type</span><span class="o">));</span>
            <span class="n">loader</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ExtensionLoader</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;)</span> <span class="no">EXTENSION_LOADERS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">loader</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>ç¬¬äºŒæ­¥ï¼šæ¥ä¸‹æ¥çœ‹çœ‹getExtensionæ–¹æ³•å¦‚ä½•åˆ›å»ºæ‰©å±•ç±»çš„å®ä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ç¬¬ä¸€èŠ‚ä½¿ç”¨çš„æ—¶å€™è¯´è¿‡ï¼ŒDubbo SPIé€šè¿‡é”®å€¼å¯¹æ¥å®šä¹‰æ‰©å±•ç±»çš„åŠ è½½ï¼Œè¿™é‡Œä¼ å…¥å…·ä½“çš„æ‰©å±•ç±»çš„keyæ¥è·å–æ‰©å±•ç±»å¯¹è±¡</span>
<span class="c1">// è¿™ä¸ªé”®å€¼å¯¹çš„è®¾è®¡å¯ä»¥å®ç°æŒ‰éœ€åŠ è½½ï¼Œæ ¹æ®keyæ¥åŠ è½½å¹¶åˆå§‹åŒ–æŸä¸ªæ‰©å±•å¯¹è±¡ï¼Œä¸åƒJava SPIä¸€æ¬¡æ€§åŠ è½½å¹¶åˆå§‹åŒ–æ‰€æœ‰æ‰©å±•ç±»ã€‚</span>
<span class="kd">public</span> <span class="no">T</span> <span class="nf">getExtension</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Extension name == null"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="s">"true"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getDefaultExtension</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// é€šè¿‡æ ‡å‡†çš„åŒé‡æ£€éªŒå•ä¾‹æ¨¡å¼æ¥ä¿è¯keyå¯¹åº”æ‰©å±•ç±»å¯¹è±¡çš„å•ä¾‹</span>
    <span class="c1">// è¿™é‡Œæ˜¯æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼Œç¼“å­˜å‘½ä¸­å°±ç›´æ¥è¿”å›æ‰©å±•ç±»å¯¹è±¡å®ä¾‹</span>
    <span class="kd">final</span> <span class="nc">Holder</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">holder</span> <span class="o">=</span> <span class="n">getOrCreateHolder</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="nc">Object</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// é‡ç‚¹åœ¨createExtensionæ–¹æ³•ï¼šå¦‚æœç¼“å­˜æ²¡å‘½ä¸­ï¼Œåˆ™èµ°è¿™é‡ŒåŠ è½½å¹¶åˆ›å»ºkeyå¯¹åº”çš„æ‰©å±•ç±»å¯¹è±¡</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">createExtension</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                <span class="n">holder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">instance</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç¬¬ä¸‰æ­¥ï¼šç»§ç»­è·Ÿè¸ªcreateExtensionæ–¹æ³•ï¼šåŠ è½½å¹¶åˆ›å»ºkeyå¯¹åº”çš„æ‰©å±•ç±»å¯¹è±¡ï¼Œæœ€ç»ˆé€šè¿‡åå°„åˆ›å»ºæ‰©å±•ç±»çš„å®ä¾‹</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="no">T</span> <span class="nf">createExtension</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// getExtensionClassesæ–¹æ³•çš„ä½œç”¨æ˜¯æ‰«æç‰¹å®šçš„ç›®å½•æ¥åŠ è½½Dubbo SPIå®šä¹‰çš„é”®å€¼å¯¹æ˜ å°„å…³ç³»ï¼Œå³keyå’Œvalueï¼Œå¹¶æ”¾åˆ°æœ¬åœ°ç¼“å­˜ä¸­ã€‚</span>
    <span class="c1">// valueå°±æ˜¯å®ç°æ–¹æä¾›çš„å…·ä½“å®ç°ç±»çš„å…¨é™å®šåã€‚</span>
    <span class="cm">/* æ‰«æçš„ç›®å½•å¦‚ä¸‹åˆ—è¡¨ï¼š
         META-INF/services/
         META-INF/dubbo/
         META-INF/dubbo/internal/
         
       å¯ä»¥çœ‹å‡ºDubboå¯¹Java SPIç›®å½•åšäº†å…¼å®¹ã€‚
       
       getExtensionClasses()æ–¹æ³•é‡Œé¢è¿˜åŒ…å«äº†ç±»åŠ è½½çš„è¿‡ç¨‹ï¼ŒåŸºæœ¬ä¸Java SPIç±»ä¼¼ï¼Œè¿™é‡Œä¸èµ˜è¿°
     */</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">getExtensionClasses</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="nf">findException</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// æ ¹æ®getExtensionClasses().get(name)è·å–åˆ°äº†keyå¯¹åº”çš„æ‰©å±•ç±»çš„Classå¯¹è±¡ï¼Œå…ˆæŸ¥è¯¢ç¼“å­˜</span>
        <span class="no">T</span> <span class="n">instance</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="no">EXTENSION_INSTANCES</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™é€šè¿‡åå°„åˆ›å»ºæ‰©å±•ç±»çš„ç¤ºä¾‹å¹¶æ·»åŠ åˆ°æœ¬åœ°ç¼“å­˜ï¼Œä¸‹æ¬¡å†æ¥å°±ç›´æ¥èµ°ç¼“å­˜</span>
            <span class="no">EXTENSION_INSTANCES</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">());</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="no">EXTENSION_INSTANCES</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// Dubbo SPIè¿˜æä¾›äº†IoCç‰¹æ€§æ¥æ³¨å…¥æ‰©å±•ç±»æ‰€ä¾èµ–çš„å…¶ä»–å¯¹è±¡ï¼Œä¸è¿‡Dubbo SPIåªæ”¯æŒsetteræ–¹æ³•æ³¨å…¥æ–¹å¼</span>
        <span class="c1">// åé¢ç« èŠ‚å°†å•ç‹¬å¯¹Dubbo SPIçš„IoCåšåˆ†æï¼Œè¿™é‡Œå…ˆç•¥è¿‡</span>
        <span class="n">injectExtension</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">wrapperClasses</span> <span class="o">=</span> <span class="n">cachedWrapperClasses</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">CollectionUtils</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">wrapperClasses</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">wrapperClass</span> <span class="o">:</span> <span class="n">wrapperClasses</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">injectExtension</span><span class="o">((</span><span class="no">T</span><span class="o">)</span> <span class="n">wrapperClass</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="n">type</span><span class="o">).</span><span class="na">newInstance</span><span class="o">(</span><span class="n">instance</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">initExtension</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Extension instance (name: "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">", class: "</span> <span class="o">+</span>
                <span class="n">type</span> <span class="o">+</span> <span class="s">") couldn't be instantiated: "</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">t</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç¬¬å››æ­¥ï¼šgetExtensionClassesæ–¹æ³•çš„ä½œç”¨æ˜¯æ‰«æç‰¹å®šçš„ç›®å½•æ¥åŠ è½½Dubbo SPIå®šä¹‰çš„é”®å€¼å¯¹æ˜ å°„å…³ç³»ï¼Œå³keyå’Œvalueï¼Œå¹¶æ”¾åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">final</span> <span class="nc">Holder</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;&gt;&gt;</span> <span class="n">cachedClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Holder</span><span class="o">&lt;&gt;();</span>

<span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">getExtensionClasses</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// å…ˆä»ç¼“å­˜ä¸­è·å–å½“å‰å·²åŠ è½½çš„æ‰©å±•ç±»çš„Classå¯¹è±¡</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">cachedClasses</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">classes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">// ç¼“å­˜æœªå‘½ä¸­åˆ™ä½¿ç”¨åŒé‡æ£€éªŒå•ä¾‹æ¨¡å¼ï¼šåŠ é”</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">cachedClasses</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">cachedClasses</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">classes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// åŠ è½½æ‰€æœ‰çš„æ‰©å±•ç±»çš„Classå¯¹è±¡ï¼šåªæ˜¯åŠ è½½æ‰©å±•ç±»ï¼Œå¹¶æœªåˆ›å»ºå®ä¾‹</span>
                <span class="n">classes</span> <span class="o">=</span> <span class="n">loadExtensionClasses</span><span class="o">();</span>
                <span class="c1">// cachedClassesç¼“å­˜äº†æ‰€æœ‰çš„æ‰©å±•ç±»çš„Classå¯¹è±¡ï¼šè¿™äº›Classå¯¹è±¡å¯ä»¥ç”¨æ¥åˆ›å»ºå¯¹åº”çš„æ‰©å±•ç±»çš„å®ä¾‹</span>
                <span class="n">cachedClasses</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">classes</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">classes</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç¬¬äº”æ­¥ï¼šloadExtensionClassesæ–¹æ³•åŠ è½½æ‰€æœ‰æ‰©å±•ç±»</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SERVICES_DIRECTORY</span> <span class="o">=</span> <span class="s">"META-INF/services/"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DUBBO_DIRECTORY</span> <span class="o">=</span> <span class="s">"META-INF/dubbo/"</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DUBBO_INTERNAL_DIRECTORY</span> <span class="o">=</span> <span class="no">DUBBO_DIRECTORY</span> <span class="o">+</span> <span class="s">"internal/"</span><span class="o">;</span>

<span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">loadExtensionClasses</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">cacheDefaultExtensionName</span><span class="o">();</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">extensionClasses</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    
    <span class="c1">// loadDirectoryæ–¹æ³•å°±æ˜¯å®é™…è¯»å–æŒ‡å®šç›®å½•ä¸‹çš„SPIæ¥å£å…¨é™å®šåä¸ºæ–‡ä»¶åçš„æ–‡ä»¶ï¼Œå¹¶è§£æ</span>
    <span class="n">loadDirectory</span><span class="o">(</span><span class="n">extensionClasses</span><span class="o">,</span> <span class="no">DUBBO_INTERNAL_DIRECTORY</span><span class="o">,</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">loadDirectory</span><span class="o">(</span><span class="n">extensionClasses</span><span class="o">,</span> <span class="no">DUBBO_INTERNAL_DIRECTORY</span><span class="o">,</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">"org.apache"</span><span class="o">,</span> <span class="s">"com.alibaba"</span><span class="o">),</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">loadDirectory</span><span class="o">(</span><span class="n">extensionClasses</span><span class="o">,</span> <span class="no">DUBBO_DIRECTORY</span><span class="o">,</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="n">loadDirectory</span><span class="o">(</span><span class="n">extensionClasses</span><span class="o">,</span> <span class="no">DUBBO_DIRECTORY</span><span class="o">,</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">"org.apache"</span><span class="o">,</span> <span class="s">"com.alibaba"</span><span class="o">));</span>
    <span class="n">loadDirectory</span><span class="o">(</span><span class="n">extensionClasses</span><span class="o">,</span> <span class="no">SERVICES_DIRECTORY</span><span class="o">,</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="n">loadDirectory</span><span class="o">(</span><span class="n">extensionClasses</span><span class="o">,</span> <span class="no">SERVICES_DIRECTORY</span><span class="o">,</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">"org.apache"</span><span class="o">,</span> <span class="s">"com.alibaba"</span><span class="o">));</span>
    
    <span class="c1">// loadExtensionClasses()ç»“æŸä¹‹åï¼Œå°±å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„æ‰©å±•ç±»çš„Classå¯¹è±¡</span>
    <span class="c1">// ä¾‹å¦‚æœ‰ä¸¤ä¸ªæ‰©å±•ç±»ï¼š</span>
    <span class="c1">//     epson-v1 = com.epson.printer.EpsonV1Printer</span>
    <span class="c1">//     epson-v2 = com.epson.printer.EpsonV2Printer</span>
    <span class="c1">// å°±ä¼šå¾—åˆ°ï¼šMap&lt;"epson-v1", Class&lt;EpsonV1Printer&gt;&gt; å’Œ Map&lt;"epson-v2", Class&lt;EpsonV2Printer&gt;&gt;</span>
    <span class="c1">// åé¢å¦‚æœæƒ³è¦åˆ›å»ºæŸä¸ªæ‰©å±•ç±»çš„å®ä¾‹ï¼Œç›´æ¥é€šè¿‡keyè·å–å¯¹åº”æ‰©å±•ç±»çš„Classå¯¹è±¡ï¼Œé€šè¿‡åå°„å°±å¯ä»¥åˆ›å»º</span>
    <span class="c1">// è¿™å°±ä¸ç¬¬ä¸‰æ­¥ä¸­çš„createExtensionæ–¹æ³•ä¸­åå°„åˆ›å»ºå®ä¾‹å¯¹åº”èµ·æ¥äº†</span>
    <span class="k">return</span> <span class="n">extensionClasses</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>loadExtensionClasses()ç»“æŸä¹‹åï¼Œå°±å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„æ‰©å±•ç±»çš„Classå¯¹è±¡ï¼Œè€Œä¸”æ‰©å±•ç±»çš„Classå¯¹è±¡æ˜¯ä»¥key-valueæ–¹å¼ç¼“å­˜èµ·æ¥ï¼Œåé¢å¦‚æœæƒ³è¦åˆ›å»ºæŸä¸ªæ‰©å±•ç±»çš„å®ä¾‹ï¼Œç›´æ¥é€šè¿‡keyè·å–å¯¹åº”æ‰©å±•ç±»çš„Classå¯¹è±¡ï¼Œé€šè¿‡åå°„å°±å¯ä»¥åˆ›å»ºï¼Œå³å¯ä»¥åšåˆ°æŒ‰éœ€åŠ è½½æ‰©å±•ç±»ï¼Œè¿™ç‚¹æ¯”Java SPIè¦å¼ºå¤§ã€‚</p>

<h3 id="ä¸‰dubbo-ioc">ä¸‰ã€Dubbo IoC</h3>

<p>Dubbo SPIé‡Œé¢ä½¿ç”¨åˆ°äº†Dubbo IoCæ³¨å…¥ä¾èµ–ï¼Œç›´æ¥æ¥çœ‹injectExtensionæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="no">T</span> <span class="nf">injectExtension</span><span class="o">(</span><span class="no">T</span> <span class="n">instance</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">objectFactory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// éå†ç›®æ ‡ç±»çš„æ‰€æœ‰æ–¹æ³•</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">instance</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethods</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// æ£€æµ‹æ–¹æ³•æ˜¯å¦ä»¥ set å¼€å¤´ï¼Œä¸”æ–¹æ³•ä»…æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä¸”æ–¹æ³•è®¿é—®çº§åˆ«ä¸º public</span>
            <span class="c1">// æ³¨æ˜ï¼šDubbo IoCé€šè¿‡setteræ–¹æ³•æ³¨å…¥ä¾èµ–</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">isSetter</span><span class="o">(</span><span class="n">method</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// å¦‚æœç›®æ ‡ç±»çš„æ–¹æ³•ä½¿ç”¨äº†@DisableInjectæ³¨è§£ï¼Œåˆ™è¯¥æ–¹æ³•ä¸æ³¨å…¥</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">DisableInject</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// è·å–setteræ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼šåªæ³¨å…¥ç¬¬ä¸€ä¸ªå‚æ•°</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">pt</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">()[</span><span class="mi">0</span><span class="o">];</span>
            <span class="c1">// å¦‚æœè¯¥å‚æ•°æ˜¯åŸºç¡€æ•°æ®ç±»å‹ï¼ˆbyteã€shortã€intã€longã€floatã€doubleã€boolenã€charï¼‰ï¼šä¸æ³¨å…¥ä¾èµ–</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">ReflectUtils</span><span class="o">.</span><span class="na">isPrimitives</span><span class="o">(</span><span class="n">pt</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// è·å–éœ€è¦æ³¨å…¥çš„å­—æ®µå</span>
                <span class="c1">// ä¾‹å¦‚ç›®æ ‡ç±»ä¾èµ–äº† private FooObj fooObj;</span>
                <span class="c1">// åˆ™å¯¹åº”çš„setteræ–¹æ³•ä¸ºï¼šsetFooObj(FooObj fooObj)</span>
                <span class="c1">// getSetterProperty(method) æœ€ç»ˆè¿”å› "fooObj"</span>
                <span class="nc">String</span> <span class="n">property</span> <span class="o">=</span> <span class="n">getSetterProperty</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
                <span class="c1">// ä»åº”ç”¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒè·å– FooObj çš„å®ä¾‹ï¼šfooObj</span>
                <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">objectFactory</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="n">pt</span><span class="o">,</span> <span class="n">property</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">object</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// é€šè¿‡åå°„è°ƒç”¨setteræ–¹æ³•ï¼Œå°† FooObj çš„å®ä¾‹ï¼šfooObj æ³¨å…¥ç›®æ ‡ç±»ï¼Œå®Œæˆä¾èµ–æ³¨å…¥</span>
                    <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">instance</span><span class="o">,</span> <span class="n">object</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to inject via method "</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">" of interface "</span> <span class="o">+</span> <span class="n">type</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™é‡Œæ¥çœ‹çœ‹Dubbo IoCå¦‚ä½•ä»åº”ç”¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒè·å– FooObj çš„å®ä¾‹ï¼šfooObj</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ExtensionLoaderç±»çš„æˆå‘˜å˜é‡</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">ExtensionFactory</span> <span class="n">objectFactory</span><span class="o">;</span>

<span class="c1">// ExtensionLoaderç±»çš„ç§æœ‰æ„é€ å‡½æ•°</span>
<span class="kd">private</span> <span class="nf">ExtensionLoader</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="n">type</span><span class="o">;</span>
    <span class="c1">// ExtensionFactoryä¹Ÿæ˜¯ä¸€ä¸ªDubbo SPIæ¥å£ï¼Œä¹Ÿæ˜¯é€šè¿‡SPIæ–¹å¼åŠ è½½æ¥çš„</span>
    <span class="n">objectFactory</span> <span class="o">=</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ExtensionFactory</span><span class="o">.</span><span class="na">class</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">ExtensionLoader</span><span class="o">.</span><span class="na">getExtensionLoader</span><span class="o">(</span><span class="nc">ExtensionFactory</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getAdaptiveExtension</span><span class="o">());</span>
<span class="o">}</span>
    
<span class="c1">// è¿™ä¸ªå°±æ˜¯ä»åº”ç”¨ä¸Šä¸‹æ–‡ç¯å¢ƒè·å–åˆ°æ‰€ä¾èµ–çš„ç±»çš„å®ä¾‹</span>
<span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">objectFactory</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="n">pt</span><span class="o">,</span> <span class="n">property</span><span class="o">);</span>
</code></pre></div></div>

<p>Dubbo ç›®å‰æä¾›äº†ä¸¤ç§ ExtensionFactoryï¼Œåˆ†åˆ«æ˜¯ SpiExtensionFactory å’Œ SpringExtensionFactoryã€‚å‰è€…ç”¨äºåˆ›å»ºè‡ªé€‚åº”çš„æ‹“å±•ï¼Œåè€…æ˜¯ç”¨äºä» Spring çš„ IOC å®¹å™¨ä¸­è·å–æ‰€éœ€çš„æ‹“å±•ã€‚</p>

<hr />

<p>å‚è€ƒï¼š</p>

<ul>
  <li><a href="https://dubbo.apache.org/zh/docs/v2.7/dev/source/dubbo-spi/" target="_blank">Dubbo SPI</a></li>
</ul>


        </div>
      </div>
    </div>
  </body>
  <div class="footer">
  <p>Copyright Â© 2021-2023&nbsp;|&nbsp;Powered by <a href="http://jekyllcn.com" target="_blank">Jekyll</a>. Theme by <a href="https://github.com/loji44/ExSimple" target="_blank">ExSimple</a>.</p>
</div>
</html>
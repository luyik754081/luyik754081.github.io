<!-- æ–‡ç« å†…å®¹å¸ƒå±€é¡µ -->
<!DOCTYPE html>
<html lang="en">
  <!-- head.htmlå­˜æ”¾é¡µé¢é€šç”¨çš„å…ƒæ•°æ®ã€cssã€jsç­‰é“¾æ¥èµ„æº -->
<head>
  <meta name="generator" content="Hugo 0.79.1" />
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Java ThreadLocalRandom | Luyik754081's blog</title>
  <meta name="description" content="Loji44&#39;s Blog. Focus on Java, Linux, Golang, Git, Vim, Docker, etc." />
  <meta name="viewport" content="width=device-width" />
  <link href="/favicon.png" rel="icon" />
  <link rel="stylesheet" href="/static/css/github.css" />
  <link rel="stylesheet" href="/static/css/style.css" />
  <link rel="stylesheet" href="/static/css/search.css" />

  <script src="//cdn.staticfile.org/jquery/1.11.3/jquery.min.js"></script>
  <script type="text/javascript" src="/static/js/is.min.js"></script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <script type="text/javascript" src="/static/js/search.js" defer="true"></script>
</head>
  <body>
    <div id="container">
      <!-- å…¨å±€é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="header">
  <span class="title"><a href="/">Luyik754081's blog</a></span>
  
    
    
    &#47;&nbsp;<a class="extra" href="/about.html">About</a>
  
    
    
    &#47;&nbsp;<a class="extra" href="/tags.html">TAGS</a>
  
    
    
    &#47;&nbsp;<a class="extra" href="/search.html">ğŸ”SEARCH</a>
  
</div>
      <div class="site">
        <!-- postæ–‡ç« çš„æ ‡é¢˜éƒ¨åˆ† -->
<div id="page_header">
  <div id="page_title">
    <h1>Java ThreadLocalRandom</h1>
  </div>
  <div id="page_meta">
    <span class="page_meta_tags">
      &#91;&nbsp;
      
        <!-- '/'å’Œç©ºæ ¼è½¬æ¢æˆ'-'ã€tagè‹±æ–‡è½¬æ¢æˆå°å†™å­—æ¯ -->
        
        <a class="extra" href="/tags/java.html">#Java</a>
      
      &nbsp;&#93;
    </span>
    <span class="page_meta_date">
        &#91;&nbsp;28 September 2019&nbsp;&#93;
    </span>
  </div>
</div>

        <div class="post">
          <p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°éœ€è¦ç”Ÿæˆéšæœºæ•°çš„æƒ…å†µã€‚ä¸€èˆ¬æˆ‘éƒ½æ˜¯ç›´æ¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">java.util.Random</code>ç±»ç›´æ¥ç”Ÿæˆï¼Œå› ä¸ºRandomç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®Œå…¨å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«å®ƒçš„å®ä¾‹ã€‚æˆ‘ä¸€ç›´éƒ½æ˜¯è¿™æ ·ç”¨çš„ï¼Œå¥½åƒå¹¶æ²¡æœ‰è§‰å¾—æœ‰ä»€ä¹ˆä¸å¦¥ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RandomUtils</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
    
    <span class="kd">private</span> <span class="nf">RandomUtils</span><span class="o">()</span> <span class="o">{}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">nextInt</span><span class="o">(</span><span class="kt">int</span> <span class="n">bound</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">bound</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ç›´åˆ°æˆ‘çœ‹äº†é˜¿é‡Œå·´å·´çš„å¼€å‘æ‰‹å†Œï¼Œæ‰å‘ç°æˆ‘è¿™ç§ç”¨æ³•æ˜¯ä¸å¤ªå¥½çš„ã€‚ä»¥ä¸‹æ‘˜è‡ªé˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œï¼š</p>

<blockquote>
  <p>ã€æ¨èã€‘é¿å…Randomå®ä¾‹è¢«å¤šçº¿ç¨‹ä½¿ç”¨ï¼Œè™½ç„¶å…±äº«è¯¥å®ä¾‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†ä¼šå› ç«äº‰åŒä¸€seedå¯¼è‡´çš„æ€§èƒ½ä¸‹é™ã€‚ <br />
è¯´æ˜ï¼šRandomå®ä¾‹åŒ…æ‹¬<code class="language-plaintext highlighter-rouge">java.util.Random</code>çš„å®ä¾‹æˆ–è€…<code class="language-plaintext highlighter-rouge">Math.random()</code>çš„æ–¹å¼ã€‚ <br />
æ­£ä¾‹ï¼šJDK7ä¹‹åï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ API ThreadLocalRandomï¼›JDK7ä¹‹å‰ï¼Œéœ€è¦ç¼–ç ä¿è¯æ¯ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ªå®ä¾‹ã€‚</p>
</blockquote>

<p>å¥½å§ï¼Œæˆ‘æ‰¿è®¤æ˜¯æˆ‘å¤ªèœäº†ã€‚æˆ‘ä¹‹å‰çš„ç”¨æ³•å…¶å®æ²¡é”™ï¼Œä½†æ˜¯åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œå±äºä¸æ¨èçš„ä½¿ç”¨æ–¹å¼ã€‚</p>

<h3 id="ä¸€ç›´æ¥å…±äº«randomå®ä¾‹çš„é—®é¢˜">ä¸€ã€ç›´æ¥å…±äº«Randomå®ä¾‹çš„é—®é¢˜</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Random</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>
    
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicLong</span> <span class="n">seed</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mh">0x5DEECE66D</span><span class="no">L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">addend</span> <span class="o">=</span> <span class="mh">0xB</span><span class="no">L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
    
    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">next</span><span class="o">(</span><span class="kt">int</span> <span class="n">bits</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">oldseed</span><span class="o">,</span> <span class="n">nextseed</span><span class="o">;</span>
        <span class="nc">AtomicLong</span> <span class="n">seed</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">seed</span><span class="o">;</span>
        <span class="k">do</span> <span class="o">{</span>
            <span class="n">oldseed</span> <span class="o">=</span> <span class="n">seed</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>  <span class="c1">// è·å–ä¸Šä¸€æ¬¡çš„seed</span>
            <span class="n">nextseed</span> <span class="o">=</span> <span class="o">(</span><span class="n">oldseed</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">+</span> <span class="n">addend</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="o">;</span>  <span class="c1">// è®¡ç®—æ–°çš„seed</span>
            <span class="c1">// CASæ“ä½œè®¾ç½®æ–°çš„seedï¼šå¤šçº¿ç¨‹å¹¶å‘æ›´æ–°seedï¼Œå¤±è´¥çš„çº¿ç¨‹ä¼šè‡ªæ—‹é‡è¯•</span>
        <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">seed</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">oldseed</span><span class="o">,</span> <span class="n">nextseed</span><span class="o">));</span>
        <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="n">nextseed</span> <span class="o">&gt;&gt;&gt;</span> <span class="o">(</span><span class="mi">48</span> <span class="o">-</span> <span class="n">bits</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Randomåœ¨ç”Ÿæˆéšæœºæ•°çš„æ—¶å€™ï¼Œæ˜¯æ ¹æ®seedæ¥è®¡ç®—ç”Ÿæˆçš„ï¼š</p>

<ol>
  <li>å…ˆæ‹¿åˆ°ä¸Šä¸€æ¬¡çš„seed</li>
  <li>ç„¶åæ ¹æ®ä¸Šä¸€æ¬¡çš„seedï¼Œè®¡ç®—æ–°çš„seed</li>
  <li>æœ€åä½¿ç”¨CASæ“ä½œè®¾ç½®æ–°çš„seed</li>
</ol>

<p>çœ‹ä¸Šé¢Randomçš„nextæ–¹æ³•æºç ï¼Œåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼ŒCASæ“ä½œä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚å› ä¸ºä¼šæœ‰å¾ˆå¤šçº¿ç¨‹æ›´æ–°seedå¤±è´¥è€Œè‡ªæ—‹é‡è¯•ï¼Œç«äº‰å¾ˆæ¿€çƒˆï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p>

<p>æ‰€ä»¥ï¼Œæœ€å¥½èƒ½ä¿è¯æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„Randomå®ä¾‹ï¼Œé¿å…å¹¶å‘æƒ…å†µä¸‹å¤šçº¿ç¨‹åŒæ—¶ç«äº‰æ›´æ–°seedçš„å€¼å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ã€‚ä¸‹é¢ä½¿ç”¨ThreadLocalæ¥å°†Randomå®ä¾‹éš”ç¦»èµ·æ¥ï¼Œè®©æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„Randomå®ä¾‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">RandomUtils</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">Random</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;&gt;();</span>
    
    <span class="kd">private</span> <span class="nf">RandomUtils</span><span class="o">()</span> <span class="o">{}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">nextInt</span><span class="o">(</span><span class="kt">int</span> <span class="n">bound</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getThreadLocalRandom</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">bound</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Random</span> <span class="nf">getThreadLocalRandom</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<h3 id="äºŒä½¿ç”¨threadlocalrandom">äºŒã€ä½¿ç”¨ThreadLocalRandom</h3>

<p>JDK7ä»¥åŠä¹‹åçš„ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">java.util.concurrent.ThreadLocalRandom</code>ç±»ï¼Œå®ƒå·²ç»å¸®æˆ‘ä»¬å°è£…å¥½äº†ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ–¹ä¾¿å¾ˆå¤šï¼Œç›´æ¥åœ¨ç”¨åˆ°éšæœºæ•°çš„åœ°æ–¹ä½¿ç”¨<code class="language-plaintext highlighter-rouge">ThreadLocalRandom.current().nextInt()</code>å³å¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalRandomTest</span> <span class="o">{</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
       <span class="kt">int</span> <span class="n">randomInt</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">();</span>
       <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"éšæœºæ•°ï¼š"</span> <span class="o">+</span> <span class="n">randomInt</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åªéœ€è¦åœ¨ä½¿ç”¨åˆ°éšæœºæ•°çš„åœ°æ–¹é€šè¿‡<code class="language-plaintext highlighter-rouge">ThreadLocalRandom.current()</code>è¿™ç§æ–¹å¼å°±å¯ä»¥è·å–åˆ°å½“å‰çº¿ç¨‹çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼Œè€Œä¸éœ€è¦å…±äº«ThreadLocalRandomçš„å®ä¾‹ã€‚</p>

<p>ä¸è¦åœ¨å¤šçº¿ç¨‹é—´å…±äº«ThreadLocalRandomçš„å®ä¾‹ï¼Œå› ä¸ºè¿™æ ·è·Ÿå…±äº«Randomå®ä¾‹ä¸€æ ·ä¼šäº§ç”Ÿå¹¶å‘æ›´æ–°<code class="language-plaintext highlighter-rouge">seed</code>çš„ç«äº‰ã€‚</p>

<hr />


        </div>
      </div>
    </div>
  </body>
  <div class="footer">
  <p>Copyright Â© 2021-2023&nbsp;|&nbsp;Powered by <a href="http://jekyllcn.com" target="_blank">Jekyll</a>. Theme by <a href="https://github.com/loji44/ExSimple" target="_blank">ExSimple</a>.</p>
</div>
</html>